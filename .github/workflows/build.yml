name: Build and Publish Trello Power-Up

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  deploy:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PROXY_URL: ${{ vars.PROXY_URL }}
    concurrency:
      group: trello-power-up-pages-${{ github.ref }}
      cancel-in-progress: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Determine target folder
      id: target
      run: |
        if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
          SAFE="pr-${PR_NUMBER}"
          SAFE=$(printf '%s' "$SAFE" | tr -c '[:alnum:]._-' '-')
          SAFE=$(printf '%s' "$SAFE" | sed 's/\-\{2,\}/-/g')
          SAFE=${SAFE#-}
          SAFE=${SAFE%-}
          echo "folder=preview/$SAFE" >> "$GITHUB_OUTPUT"
        elif [ "$GITHUB_REF_NAME" = "main" ]; then
          echo "folder=" >> "$GITHUB_OUTPUT"
        else
          SAFE=$(printf '%s' "$GITHUB_REF_NAME" | tr -c '[:alnum:]._-/' '-')
          SAFE=$(printf '%s' "$SAFE" | sed 's/\-\{2,\}/-/g')
          SAFE=${SAFE#-}
          SAFE=${SAFE%-}
          if [ -z "$SAFE" ]; then
            SAFE="branch"
          fi
          echo "folder=preview/$SAFE" >> "$GITHUB_OUTPUT"
        fi
      env:
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        PR_NUMBER: ${{ github.event.number }}

    - name: Checkout existing gh-pages branch
      uses: actions/checkout@v3
      with:
        ref: gh-pages
        path: gh-pages
      continue-on-error: true

    - name: Prepare distribution
      run: |
        rm -rf dist
        mkdir -p dist
        if [ -d gh-pages ]; then
          cp -R gh-pages/. dist/
        fi

        TARGET="${{ steps.target.outputs.folder }}"
        if [ -z "$TARGET" ]; then
          mkdir -p dist/preview
          find dist -mindepth 1 -maxdepth 1 ! -name 'preview' ! -name 'CNAME' ! -name '.nojekyll' -exec rm -rf {} +
          cp -R src/trello-power-up/. dist/
        else
          mkdir -p "$(dirname "dist/$TARGET")"
          rm -rf "dist/$TARGET"
          mkdir -p "dist/$TARGET"
          cp -R src/trello-power-up/. "dist/$TARGET/"
        fi

        if [ -z "$TARGET" ]; then
          DEST_DIR="dist"
        else
          DEST_DIR="dist/$TARGET"
        fi

        if [ -n "$PROXY_URL" ]; then
          python3 - "$DEST_DIR" "$PROXY_URL" <<'PY'
import json
import pathlib
import sys

dest_dir = pathlib.Path(sys.argv[1])
proxy_url = sys.argv[2]

config = "window.trelloPlayerConfig = window.trelloPlayerConfig || {};\n"
config += "window.trelloPlayerConfig.proxyUrl = " + json.dumps(proxy_url) + ";\n"

dest_file = dest_dir / "trello-player-config.js"
dest_file.write_text(config, encoding="utf-8")
PY
        fi
        touch dist/.nojekyll

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: dist
        clean: true
