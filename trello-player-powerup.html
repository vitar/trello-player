<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trello Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background-color: black;
        color: lightgrey;
      }
    }
    @media (prefers-color-scheme: light) {
      body {
        background-color: lightgrey;
        color: black;
      }
    }
    .attachment {
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
    audio {
      display: block;
      margin-top: 10px;
    }
    .controls {
      margin-top: 10px;
    }
    .controls button {
      margin-right: 10px;
    }
    .active {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 id="list-name">Trello Player</h1>
  <div id="attachments-container">
    <audio id="audio-player" controls></audio>
    <div class="controls">
      <button id="prev-button">Previous</button>
      <button id="next-button">Next</button>
    </div>
    <ul id="attachments-list" class="attachments"></ul>
  </div>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const t = TrelloPowerUp.iframe();

    let currentAttachmentIndex = 0;
    let m4aAttachments = [];
    let audioPlayer = document.getElementById('audio-player');

    // Function to load attachments
    function loadAttachments() {
      t.card('attachments')
        .get('attachments')
        .then(function(attachments) {
          const filteredAttachments = attachments.filter(attachment => attachment.url.endsWith('.m4a'));
          if (filteredAttachments.length === 0) {
            document.getElementById('attachments-container').innerHTML = '<p>No .m4a attachments found.</p>';
            return;
          }
          m4aAttachments = filteredAttachments;
          displayAttachments();
          loadAttachment(0);
        });
    }

    // Function to display the list of attachments
    function displayAttachments() {
      const attachmentsList = document.getElementById('attachments-list');
      attachmentsList.innerHTML = '';
      m4aAttachments.forEach((attachment, index) => {
        const li = document.createElement('li');
        li.textContent = attachment.name;
        li.className = 'attachment';
        if (index === 0) {
          li.classList.add('active');
        }
        attachmentsList.appendChild(li);
      });
    }

    // Function to load a specific attachment into the audio player
    function loadAttachment(index) {
      if (index >= 0 && index < m4aAttachments.length) {
        currentAttachmentIndex = index;
        audioPlayer.src = m4aAttachments[index].url;
        audioPlayer.play();

        const attachmentsListItems = document.querySelectorAll('.attachment');
        attachmentsListItems.forEach((item, idx) => {
          item.classList.toggle('active', idx === index);
        });
      }
    }

    // Event listeners for navigation buttons
    document.getElementById('prev-button').addEventListener('click', () => {
      if (currentAttachmentIndex > 0) {
        loadAttachment(currentAttachmentIndex - 1);
      }
    });

    document.getElementById('next-button').addEventListener('click', () => {
      if (currentAttachmentIndex < m4aAttachments.length - 1) {
        loadAttachment(currentAttachmentIndex + 1);
      }
    });

    // Auto play the next attachment when the current one ends
    audioPlayer.addEventListener('ended', () => {
      if (currentAttachmentIndex < m4aAttachments.length - 1) {
        loadAttachment(currentAttachmentIndex + 1);
      }
    });

    // Load the attachments when the iframe loads
    t.render(loadAttachments);
  </script>
</body>
</html>
